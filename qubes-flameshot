#!/bin/bash
set -e

path="$(mktemp --suffix .png)"
declare -a file
file[0]="/home/user/QubesIncoming/dom0/$(basename "$path")"
flameshot gui --raw > "$path"
qubes="$(qvm-ls --raw-list | grep -v -e '-dvm$'  -e '^sys-' -e '^archlinux-' -e '^debian-' -e '^fedora-' -e '^whonix-')"
qube="$(zenity --list --modal --width 150 --height 350 --title 'Flameshot' --text 'Select destination:' --column 'Qube' $qubes)"
qvm-copy-to-vm "$qube" "$path"
cmd='xclip -selection clipboard -target image/png -in '
cmd+="${file[@]@Q}"
cmd+=' && rm '
cmd+="${file[@]@Q}"
qvm-run --pass-io "$qube" "$cmd" &
pid="$!"
rm "$path"
sleep 2
kill "$pid"
